{% extends 'base.html' %}
{% load static %}

{% block title %}{{ shop.name }}{% endblock title %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/shop_detail.css' %}">
{% endblock extra_styles %}

{% block content %}

<section class="shop-hero-section">
    <a href="{% url 'home' %}" class="btn btn-back">
        <i class="fa-solid fa-arrow-left"></i> Quay lại
    </a>

    <div class="shop-cover-image">
        {% if shop.cover_image %}
            <img src="{{ shop.cover_image.url }}" alt="{{ shop.name }}">
        {% else %}
            <div class="placeholder-image">
                <i class="fa-solid fa-mug-hot fa-5x"></i>
            </div>
        {% endif %}
    </div>

    <div class="shop-info-overlay full-width-overlay">
        <div class="overlay-inner">
            <h1>{{ shop.name }}</h1>
            <div class="shop-meta">
                <span>
                    <i class="fa-solid fa-star"></i>
                    {{ shop.rating_avg|default:"0"|floatformat:1 }}
                    ({{ shop.review_count|default:"0" }} đánh giá)
                </span>
                <span><i class="fa-solid fa-map-pin"></i> {{ shop.district }}</span>
                <span><i class="fa-solid fa-dollar-sign"></i> {{ shop.price_range }}</span>
            </div>
        </div>
    </div>
</section>

<div class="shop-content-container container">
    <div class="main-content">

        <section class="shop-description-section">
            <h2>Về quán</h2>
            <p>{{ shop.description }}</p>

            <div class="shop-features">
                <h3>Đặc điểm & Không khí</h3>
                <div class="tag-list">
                    {% for tag in shop.get_tag_list %}
                        <span class="feature-tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
        </section>

        <section class="shop-menu-section">
            <h2>Menu</h2>

            {% for category, items in grouped_menu.items %}
                <div class="menu-category">
                    <h3><i class="fa-solid fa-mug-saucer"></i> {{ category }}</h3>
                    <ul class="menu-list">
                        {% for item in items %}
                            <li class="menu-item">
                                <span class="item-name">{{ item.name }}</span>
                                <span class="item-price">{{ item.price }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% empty %}
                <p>Menu đang được cập nhật.</p>
            {% endfor %}

            <p class="menu-note">
                * Giá có thể thay đổi theo thời gian.
            </p>
        </section>

        <section class="shop-review-section">
            <h2>Đánh giá & Bình luận</h2>

            {% if user.is_authenticated %}
           <form method="post"
      action="{% url 'submit_review' shop.id %}"
      class="review-form">

    {% csrf_token %}

    <div class="review-top">
        <div class="star-rating">
    <input type="radio" name="rating" id="star5" value="5">
    <label for="star5"><i class="fa-regular fa-star"></i></label>

    <input type="radio" name="rating" id="star4" value="4">
    <label for="star4"><i class="fa-regular fa-star"></i></label>

    <input type="radio" name="rating" id="star3" value="3">
    <label for="star3"><i class="fa-regular fa-star"></i></label>

    <input type="radio" name="rating" id="star2" value="2">
    <label for="star2"><i class="fa-regular fa-star"></i></label>

    <input type="radio" name="rating" id="star1" value="1">
    <label for="star1"><i class="fa-regular fa-star"></i></label>
</div>


        <button type="submit" class="btn-submit-review">
            Đăng bài đánh giá
        </button>
    </div>

    <textarea name="comment"
              placeholder="Chia sẻ trải nghiệm của bạn..."
              required></textarea>
           </form>

            {% else %}
                <p class="login-prompt">Bạn cần <a href="{% url 'login' %}">đăng nhập</a> để viết đánh giá.</p>
            {% endif %}

            <div class="reviews-list">
    {% with 3 as max_visible %}
        {% for review in reviews %}
<div class="review-card {% if forloop.counter > max_visible %}hidden-review{% endif %}">
    <div class="review-header">
        <span class="reviewer-name">@{{ review.user.username }}</span>
        <span class="review-date">{{ review.created_at|date:"d/m/Y" }}</span>
    </div>

    <div class="review-rating">
        {% for i in "12345"|make_list %}
            {% if review.rating >= forloop.counter %}
                <i class="fa-solid fa-star rated"></i>
            {% else %}
                <i class="fa-regular fa-star"></i>
            {% endif %}
        {% endfor %}
    </div>

    <p>{{ review.comment }}</p>
</div>
{% endfor %}
    {% endwith %}
</div>
        </section>

    </div>

    <div class="sidebar-content">
        <div class="info-box sticky-box">
            <h2>Thông tin</h2>
            <p><i class="fa-solid fa-location-dot"></i> {{ shop.address }}</p>
            <hr>

            <h2>Tiện nghi</h2>
            <div class="amenities-grid">
                {% for amenity in shop.get_amenities_list %}
                    <div class="amenity-item">
                        <i class="fa-solid fa-check"></i> {{ amenity }}
                    </div>
                {% endfor %}
            </div>

            <button
                id="save-btn"
                type="button"
                class="btn btn-outline-primary full-width-btn"
                data-shop-id="{{ shop.id }}"
                data-url="{% url 'toggle_save_shop' %}"
                data-csrf="{{ csrf_token }}"
            >
                <i id="save-icon" class="fa-heart {% if is_saved %}fa-solid saved{% else %}fa-regular{% endif %}"></i>
                <span style="margin-left: 8px;">Lưu yêu thích</span>
            </button>
        </div>
    </div>
</div>

<section class="gallery-section container">
    <h2>Khung cảnh quán</h2>
    <div class="shop-gallery-grid">
        {% for image in shop.images.all|slice:":4" %}
            <div class="gallery-item">
                <img src="{{ image.image.url }}" alt="{{ shop.name }}">
            </div>
        {% empty %}
            <p>Đang cập nhật hình ảnh...</p>
        {% endfor %}
    </div>
</section>
<!-- REVIEW MODAL -->
<div id="review-modal" class="review-modal">
    <div class="review-modal-content">
        <button class="modal-close">&times;</button>
        <h3>Tất cả bình luận</h3>
        <div id="all-reviews-modal"></div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/shop_detail.js' %}"></script>
{% endblock extra_scripts %}